<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广播系统管理后台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f0f2f5;
        }
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 200px;
            background: #001529;
            color: #fff;
            padding: 20px 0;
            flex-shrink: 0;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            background: #f0f2f5;
        }
        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-item:hover {
            background: #1890ff;
        }
        .nav-item.active {
            background: #1890ff;
        }
        .content-header {
            background: #fff;
            padding: 16px 24px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-body {
            background: #fff;
            padding: 24px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .card {
            margin-bottom: 20px;
        }
        .token-list {
            margin-top: 20px;
        }
        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .token-actions {
            display: flex;
            gap: 10px;
        }
        .binding-list {
            margin-top: 20px;
        }
        .binding-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #1890ff;
            margin: 10px 0;
        }
        .stat-card .title {
            color: #666;
            font-size: 14px;
        }
        .stat-card .icon {
            float: right;
            font-size: 24px;
            color: #1890ff;
            opacity: 0.2;
        }
        .details-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .details-title {
            color: #333;
            font-weight: 500;
        }
        .details-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .details-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: white;
            transition: transform 0.2s;
        }
        .details-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .details-item.online {
            background-color: #e8f5e9;
            border-color: #a5d6a7;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            float: right;
        }
        .status-badge.online {
            background-color: #4caf50;
            color: white;
        }
        .status-badge.offline {
            background-color: #9e9e9e;
            color: white;
        }
        .content-section {
            display: none;  /* 默认隐藏所有内容区域 */
        }
        
        .content-section.active {
            display: block;  /* 显示激活的内容区域 */
        }
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
        }
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .message-meta {
            font-size: 0.9em;
            color: #666;
        }
        .message-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .message-type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }
        .message-type-text {
            background-color: #1890ff;
        }
        .message-type-audio {
            background-color: #52c41a;
        }
        .audio-player {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="nav-item active" data-content="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>仪表盘</span>
            </div>
            <div class="nav-item" data-content="teacher">
                <i class="fas fa-chalkboard-teacher"></i>
                <span>教师口令管理</span>
            </div>
            <div class="nav-item" data-content="class">
                <i class="fas fa-graduation-cap"></i>
                <span>班级口令管理</span>
            </div>
            <div class="nav-item" data-content="binding">
                <i class="fas fa-link"></i>
                <span>教师-班级绑定</span>
            </div>
            <div class="nav-item" data-content="messages">
                <i class="fas fa-broadcast-tower"></i>
                <span>广播消息记录</span>
            </div>
            <div class="nav-item" data-content="broadcast">
                <i class="fas fa-bullhorn"></i>
                <span>发送广播</span>
            </div>
            <div class="nav-item text-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出登录</span>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="main-content">
            <!-- 仪表盘 -->
            <div class="content-section active" id="dashboardContent">
                <div class="content-header">
                    <h4 class="mb-0">系统概览</h4>
                </div>
                <div class="content-body">
                    <div class="dashboard-cards">
                        <div class="stat-card" onclick="showDetails('class')">
                            <i class="fas fa-graduation-cap icon"></i>
                            <div class="title">班级总数</div>
                            <div class="number" id="classCount">0</div>
                        </div>
                        <div class="stat-card" onclick="showDetails('teacher')">
                            <i class="fas fa-chalkboard-teacher icon"></i>
                            <div class="title">教师总数</div>
                            <div class="number" id="teacherCount">0</div>
                        </div>
                        <div class="stat-card" onclick="showDetails('binding')">
                            <i class="fas fa-link icon"></i>
                            <div class="title">绑定关系总数</div>
                            <div class="number" id="bindingCount">0</div>
                        </div>
                        <div class="stat-card" onclick="showDetails('online')">
                            <i class="fas fa-wifi icon"></i>
                            <div class="title">在线班级数</div>
                            <div class="number" id="onlineCount">0</div>
                        </div>
                        <div class="stat-card" onclick="showDetails('messages')">
                            <i class="fas fa-broadcast-tower icon"></i>
                            <div class="title">广播消息总数</div>
                            <div class="number" id="messageCount">0</div>
                        </div>
                    </div>

                    <!-- 添加详情展示区域 -->
                    <div class="details-section">
                        <h5 class="details-title mb-3" id="detailsTitle">详细信息</h5>
                        <div id="detailsContent"></div>
                    </div>
                </div>
            </div>

            <!-- 教师口令管理 -->
            <div class="content-section" id="teacherContent">
                <div class="content-header">
                    <h4 class="mb-0">教师口令管理</h4>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-body">
                            <form id="teacherTokenForm">
                                <div class="mb-3">
                                    <label for="teacherToken" class="form-label">口令</label>
                                    <input type="text" class="form-control" id="teacherToken" required>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherDescription" class="form-label">描述</label>
                                    <input type="text" class="form-control" id="teacherDescription">
                                </div>
                                <button type="submit" class="btn btn-primary">添加教师口令</button>
                            </form>
                            <div id="teacherTokenList" class="mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 班级口令管理 -->
            <div class="content-section" id="classContent">
                <div class="content-header">
                    <h4 class="mb-0">班级口令管理</h4>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-body">
                            <form id="classTokenForm">
                                <div class="mb-3">
                                    <label for="className" class="form-label">班级名称</label>
                                    <input type="text" class="form-control" id="className" required>
                                </div>
                                <div class="mb-3">
                                    <label for="classToken" class="form-label">口令</label>
                                    <input type="text" class="form-control" id="classToken" required>
                                </div>
                                <div class="mb-3">
                                    <label for="classDescription" class="form-label">描述</label>
                                    <input type="text" class="form-control" id="classDescription">
                                </div>
                                <button type="submit" class="btn btn-primary">添加班级口令</button>
                            </form>
                            <div id="classTokenList" class="token-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 教师-班级绑定管理 -->
            <div class="content-section" id="bindingContent">
                <div class="content-header">
                    <h4 class="mb-0">教师-班级绑定管理</h4>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-body">
                            <form id="bindingForm">
                                <div class="row align-items-end">
                                    <div class="col-md-5">
                                        <label for="teacherSelect" class="form-label">选择教师</label>
                                        <select class="form-select" id="teacherSelect" required>
                                            <option value="">选择教师</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label for="classSelect" class="form-label">选择班级</label>
                                        <select class="form-select" id="classSelect" required>
                                            <option value="">选择班级</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100">绑定</button>
                                    </div>
                                </div>
                            </form>
                            <div id="bindingList" class="binding-list mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 添加广播消息记录内容区域 -->
            <div class="content-section" id="messagesContent">
                <div class="content-header">
                    <h4 class="mb-0">广播消息记录</h4>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="messageTypeFilter">
                            <option value="">全部类型</option>
                            <option value="text">文本消息</option>
                            <option value="audio">语音消息</option>
                        </select>
                        <select class="form-select" id="teacherFilter">
                            <option value="">全部教师</option>
                        </select>
                        <select class="form-select" id="classFilter">
                            <option value="">全部班级</option>
                        </select>
                    </div>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-body">
                            <div id="messageList" class="message-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 发送广播 -->
            <div class="content-section" id="broadcastContent">
                <div class="content-header">
                    <h2>发送广播</h2>
                </div>
                <div class="content-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="broadcastType" class="form-label">广播类型</label>
                                <select class="form-select" id="broadcastType">
                                    <option value="text">文字广播</option>
                                    <option value="audio">语音广播</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="targetClass" class="form-label">目标班级</label>
                                <select class="form-select" id="targetClass">
                                    <!-- 班级列表将通过JavaScript动态填充 -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="displayMode" class="form-label">显示方式</label>
                                <select class="form-select" id="displayMode">
                                    <option value="banner">顶部横幅</option>
                                    <option value="fullscreen">全屏显示</option>
                                    <option value="popup">弹窗显示</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableSchedule" onchange="toggleScheduleOptions()">
                                    <label class="form-check-label" for="enableSchedule">定时发送</label>
                                </div>
                            </div>
                            <div id="scheduleOptions" class="mb-3" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="scheduleDate" class="form-label">发送日期</label>
                                        <input type="date" class="form-control" id="scheduleDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="scheduleTime" class="form-label">发送时间</label>
                                        <input type="time" class="form-control" id="scheduleTime">
                                    </div>
                                </div>
                            </div>
                            <div id="textBroadcast" class="mb-3">
                                <label for="textContent" class="form-label">广播内容</label>
                                <textarea class="form-control" id="textContent" rows="4"></textarea>
                            </div>
                            <div id="audioBroadcast" class="mb-3" style="display: none;">
                                <label for="audioFile" class="form-label">音频文件</label>
                                <input type="file" class="form-control" id="audioFile" accept="audio/*">
                                <div class="mt-2">
                                    <audio id="audioPreview" controls style="display: none;"></audio>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="sendBroadcast()">发送广播</button>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">在线班级状态</h5>
                                </div>
                                <div class="card-body">
                                    <div id="onlineClassList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑口令模态框 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑口令</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <input type="hidden" id="editType">
                        <div class="mb-3">
                            <label class="form-label" for="editToken">口令</label>
                            <input type="text" class="form-control" id="editToken" required>
                        </div>
                        <div class="mb-3" id="editClassNameGroup">
                            <label class="form-label" for="editClassName">班级名称</label>
                            <input type="text" class="form-control" id="editClassName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="editDescription">描述</label>
                            <input type="text" class="form-control" id="editDescription">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        let editModal;
        let currentClassStatus = {};  // 存储当前班级状态
        let ws = null;
        let token = localStorage.getItem('adminToken');
        
        // 检查登录状态
        if (!token) {
            window.location.href = 'login.html';
        }

        // 建立WebSocket连接
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                // 发送身份识别
                ws.send(JSON.stringify({
                    type: 'identity',
                    role: 'admin'
                }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'classStatus') {
                    currentClassStatus = data.status;  // 更新当前班级状态
                    const onlineCount = Object.values(data.status).filter(status => status).length;
                    document.getElementById('onlineCount').textContent = onlineCount;
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // 更新在线班级列表
        function updateOnlineClassList(status) {
            const container = document.getElementById('onlineClassList');
            container.innerHTML = '';
            
            Object.entries(status).forEach(([className, isOnline]) => {
                const div = document.createElement('div');
                div.className = 'details-item' + (isOnline ? ' online' : '');
                div.innerHTML = `
                    <span>${className}</span>
                    <span class="status-badge ${isOnline ? 'online' : 'offline'}">
                        ${isOnline ? '在线' : '离线'}
                    </span>
                `;
                container.appendChild(div);
            });
        }

        // 获取班级列表
        async function loadClassList() {
            try {
                const response = await fetch('/api/admin/class-tokens', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取班级列表失败');
                }
                
                const data = await response.json();
                
                const select = document.getElementById('targetClass');
                select.innerHTML = '<option value="">选择班级</option>';
                
                if (data && Array.isArray(data)) {
                    data.forEach(classInfo => {
                        const option = document.createElement('option');
                        option.value = classInfo.class_name;
                        option.textContent = `${classInfo.class_name} ${classInfo.description ? `(${classInfo.description})` : ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载班级列表失败:', error);
                alert('加载班级列表失败，请刷新页面重试');
            }
        }

        // 处理广播类型切换
        document.getElementById('broadcastType').addEventListener('change', function() {
            const textBroadcast = document.getElementById('textBroadcast');
            const audioBroadcast = document.getElementById('audioBroadcast');
            
            if (this.value === 'text') {
                textBroadcast.style.display = 'block';
                audioBroadcast.style.display = 'none';
            } else {
                textBroadcast.style.display = 'none';
                audioBroadcast.style.display = 'block';
            }
        });

        // 处理音频文件选择
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const audio = document.getElementById('audioPreview');
                audio.src = URL.createObjectURL(file);
                audio.style.display = 'block';
            }
        });

        // 发送广播
        async function sendBroadcast() {
            const type = document.getElementById('broadcastType').value;
            const targetClass = document.getElementById('targetClass').value;
            const displayMode = document.getElementById('displayMode').value;
            const isScheduled = document.getElementById('enableSchedule').checked;
            
            if (!targetClass) {
                alert('请选择目标班级');
                return;
            }
            
            try {
                let content;
                
                if (type === 'text') {
                    content = document.getElementById('textContent').value.trim();
                    if (!content) {
                        alert('请输入广播内容');
                        return;
                    }
                } else {
                    const file = document.getElementById('audioFile').files[0];
                    if (!file) {
                        alert('请选择音频文件');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('audio', file);
                    
                    const uploadResponse = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('音频文件上传失败');
                    }
                    
                    content = await uploadResponse.json();
                }
                
                // 准备发送的消息对象
                const message = {
                    type: type,
                    content: content,
                    targetClass: targetClass,
                    adminToken: token,
                    displayMode: displayMode // 添加显示模式
                };
                
                // 如果是定时发送
                if (isScheduled) {
                    const scheduleDate = document.getElementById('scheduleDate').value;
                    const scheduleTime = document.getElementById('scheduleTime').value;
                    
                    if (!scheduleDate || !scheduleTime) {
                        alert('请设置定时发送的日期和时间');
                        return;
                    }
                    
                    const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
                    const now = new Date();
                    
                    if (scheduledDateTime <= now) {
                        alert('定时发送时间必须是未来的时间');
                        return;
                    }
                    
                    const delay = scheduledDateTime.getTime() - now.getTime();
                    
                    alert(`广播将在 ${scheduleDate} ${scheduleTime} 发送`);
                    
                    // 设置定时发送
                    setTimeout(() => {
                        ws.send(JSON.stringify(message));
                        console.log('定时广播已发送:', message);
                    }, delay);
                } else {
                    // 立即发送
                    ws.send(JSON.stringify(message));
                    
                    alert('广播发送成功');
                    
                    // 清空输入
                    if (type === 'text') {
                        document.getElementById('textContent').value = '';
                    } else {
                        document.getElementById('audioFile').value = '';
                        document.getElementById('audioPreview').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('发送广播失败:', error);
                alert('发送广播失败: ' + error.message);
            }
        }
        
        // 切换定时选项显示
        function toggleScheduleOptions() {
            const isScheduled = document.getElementById('enableSchedule').checked;
            const scheduleOptions = document.getElementById('scheduleOptions');
            
            scheduleOptions.style.display = isScheduled ? 'block' : 'none';
            
            if (isScheduled) {
                // 设置默认值为当前时间后5分钟
                const now = new Date();
                now.setMinutes(now.getMinutes() + 5);
                
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                document.getElementById('scheduleDate').value = `${year}-${month}-${day}`;
                document.getElementById('scheduleTime').value = `${hours}:${minutes}`;
            }
        }

        // 加载消息记录
        async function loadMessages() {
            try {
                const response = await fetch('/api/admin/broadcast-messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(response.statusText || '获取消息记录失败');
                }
                
                const messages = await response.json();
                const container = document.getElementById('messageList');
                
                if (!messages || !Array.isArray(messages) || messages.length === 0) {
                    container.innerHTML = '<div class="text-muted">暂无广播消息记录</div>';
                    return;
                }

                // 更新筛选器选项
                updateFilterOptions(messages);
                
                // 保存消息数据到dataset
                container.dataset.messages = JSON.stringify(messages);
                
                // 显示消息
                displayMessages(messages);
            } catch (error) {
                console.error('加载消息记录失败:', error);
                document.getElementById('messageList').innerHTML = 
                    `<div class="alert alert-danger">加载消息记录失败: ${error.message}</div>`;
            }
        }

        // 显示消息列表
        function displayMessages(messages) {
            const container = document.getElementById('messageList');
            const filteredMessages = filterMessages(messages);
            
            if (!filteredMessages || filteredMessages.length === 0) {
                container.innerHTML = '<div class="text-muted">暂无广播消息记录</div>';
                return;
            }

            container.innerHTML = filteredMessages.map(message => {
                // 获取发送者显示名称
                let senderDisplay = '管理员';
                if (message.sender_role === 'teacher') {
                    senderDisplay = message.sender_description || message.sender_token;
                }

                // 获取显示模式的中文名称
                let displayModeText = '顶部横幅';
                if (message.display_mode === 'fullscreen') {
                    displayModeText = '全屏显示';
                } else if (message.display_mode === 'popup') {
                    displayModeText = '弹窗显示';
                }

                return `
                <div class="message-item">
                    <div class="message-header">
                        <div class="message-meta">
                            <span class="message-type-badge message-type-${message.type}">
                                ${message.type === 'text' ? '文本' : '语音'}
                            </span>
                            <span class="ms-2">发送者: ${senderDisplay}</span>
                            <span class="ms-2">目标班级: ${message.target_class}</span>
                            <span class="ms-2">显示方式: ${displayModeText}</span>
                        </div>
                        <div class="text-muted">
                            ${new Date(message.created_at).toLocaleString()}
                        </div>
                    </div>
                    <div class="message-content">
                        ${message.type === 'text' ? 
                            `<div class="message-text">${message.content}</div>` :
                            `<div class="audio-player">
                                <audio controls src="${message.content}">
                                    您的浏览器不支持音频播放
                                </audio>
                            </div>`
                        }
                    </div>
                </div>
            `}).join('');
        }

        // 更新筛选器选项
        function updateFilterOptions(messages) {
            const teachers = new Set();
            const classes = new Set();
            
            messages.forEach(message => {
                if (message.sender_role === 'teacher') {
                    teachers.add(message.sender_token);
                }
                classes.add(message.target_class);
            });

            const teacherFilter = document.getElementById('teacherFilter');
            teacherFilter.innerHTML = '<option value="">全部发送者</option>' + 
                Array.from(teachers).map(teacher => 
                    `<option value="${teacher}">${teacher}</option>`
                ).join('');

            const classFilter = document.getElementById('classFilter');
            classFilter.innerHTML = '<option value="">全部班级</option>' + 
                Array.from(classes).map(className => 
                    `<option value="${className}">${className}</option>`
                ).join('');
        }

        // 应用筛选
        function filterMessages(messages) {
            const typeFilter = document.getElementById('messageTypeFilter').value;
            const teacherFilter = document.getElementById('teacherFilter').value;
            const classFilter = document.getElementById('classFilter').value;

            return messages.filter(message => {
                if (typeFilter && message.type !== typeFilter) return false;
                if (teacherFilter && message.sender_role === 'teacher' && message.sender_token !== teacherFilter) return false;
                if (classFilter && message.target_class !== classFilter) return false;
                return true;
            });
        }

        // 打开编辑模态框
        function editToken(type, id, token, className, description) {
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editToken').value = token;
            document.getElementById('editDescription').value = description;
            
            const classNameGroup = document.getElementById('editClassNameGroup');
            if (type === 'class') {
                classNameGroup.style.display = 'block';
                document.getElementById('editClassName').value = className;
            } else {
                classNameGroup.style.display = 'none';
            }
            
            editModal.show();
        }

        // 保存编辑
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const type = document.getElementById('editType').value;
            const token = document.getElementById('editToken').value;
            const description = document.getElementById('editDescription').value;
            const className = document.getElementById('editClassName').value;

            if (!token) {
                alert('口令不能为空');
                return;
            }

            if (type === 'class' && !className) {
                alert('班级名称不能为空');
                return;
            }

            const data = { token, description };
            if (type === 'class') {
                data.class_name = className;
            }

            try {
                const result = await apiRequest(`/api/admin/${type}-tokens/${id}`, 'PUT', data);
                if (result && result.success) {
                    editModal.hide();
                    if (type === 'teacher') {
                        loadTeacherTokens();
                    } else {
                        loadClassTokens();
                    }
                    loadBindings();
                    loadMessages();
                    alert('保存成功');
                } else {
                    alert(result?.message || '保存失败，请重试');
                }
            } catch (error) {
                console.error('保存失败:', error);
                alert(error.message || '保存失败，请检查网络连接');
            }
        }

        // 删除教师口令
        async function deleteTeacherToken(id) {
            if (!confirm('确定要删除这个口令吗？')) return;
            
            const result = await apiRequest(`/api/admin/teacher-tokens/${id}`, 'DELETE');
            if (result && result.success) {
                loadTeacherTokens();
                loadBindings();
                loadMessages();
            }
        }

        // 删除班级口令
        async function deleteClassToken(id) {
            if (!confirm('确定要删除这个口令吗？')) return;
            
            const result = await apiRequest(`/api/admin/class-tokens/${id}`, 'DELETE');
            if (result && result.success) {
                loadClassTokens();
                loadBindings();
                loadMessages();
            }
        }

        // 删除绑定关系
        async function deleteBinding(id) {
            if (!confirm('确定要解除这个绑定关系吗？')) return;
            
            const result = await apiRequest(`/api/admin/teacher-class-bindings/${id}`, 'DELETE');
            if (result && result.success) {
                loadBindings();
                loadMessages();
            }
        }

        // 添加教师口令
        document.getElementById('teacherTokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = document.getElementById('teacherToken').value;
            const description = document.getElementById('teacherDescription').value;

            const result = await apiRequest('/api/admin/teacher-tokens', 'POST', {
                token,
                description
            });

            if (result && result.success) {
                document.getElementById('teacherTokenForm').reset();
                loadTeacherTokens();
                loadMessages();
            }
        });

        // 添加班级口令
        document.getElementById('classTokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const className = document.getElementById('className').value;
            const token = document.getElementById('classToken').value;
            const description = document.getElementById('classDescription').value;

            const result = await apiRequest('/api/admin/class-tokens', 'POST', {
                className,
                token,
                description
            });

            if (result && result.success) {
                document.getElementById('classTokenForm').reset();
                loadClassTokens();
                loadMessages();
            }
        });

        // 添加绑定关系
        document.getElementById('bindingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const teacherId = document.getElementById('teacherSelect').value;
            const classId = document.getElementById('classSelect').value;

            if (!teacherId || !classId) {
                alert('请选择教师和班级');
                return;
            }

            const result = await apiRequest('/api/admin/teacher-class-bindings', 'POST', {
                teacherId,
                classId
            });

            if (result && result.success) {
                document.getElementById('bindingForm').reset();
                loadBindings();
                loadMessages();
            }
        });

        // 修改显示详情函数
        async function showDetails(type) {
            const detailsTitle = document.getElementById('detailsTitle');
            const content = document.getElementById('detailsContent');
            
            try {
                switch(type) {
                    case 'class':
                        detailsTitle.textContent = '班级列表';
                        const classes = await apiRequest('/api/admin/class-tokens');
                        content.innerHTML = generateClassList(classes);
                        break;
                        
                    case 'teacher':
                        detailsTitle.textContent = '教师列表';
                        const teachers = await apiRequest('/api/admin/teacher-tokens');
                        content.innerHTML = generateTeacherList(teachers);
                        break;
                        
                    case 'binding':
                        detailsTitle.textContent = '绑定关系列表';
                        const bindings = await apiRequest('/api/admin/teacher-class-bindings');
                        content.innerHTML = generateBindingList(bindings);
                        break;
                        
                    case 'online':
                        detailsTitle.textContent = '在线班级';
                        content.innerHTML = generateOnlineClassList();
                        break;

                    case 'messages':
                        detailsTitle.textContent = '广播消息记录';
                        const messages = await apiRequest('/api/admin/broadcast-messages');
                        content.innerHTML = generateMessageList(messages);
                        break;
                }
            } catch (error) {
                console.error('获取详情失败:', error);
                content.innerHTML = `<div class="alert alert-danger">获取详情失败: ${error.message}</div>`;
            }
        }

        // 生成班级列表HTML
        function generateClassList(classes) {
            if (!classes || classes.length === 0) {
                return '<p class="text-muted">暂无班级</p>';
            }
            
            return `
                <ul class="details-list">
                    ${classes.map(c => `
                        <li class="details-item ${currentClassStatus[c.class_name] ? 'online' : ''}">
                            <div>
                                <strong>${c.class_name}</strong>
                                ${c.description ? `<br><small class="text-muted">${c.description}</small>` : ''}
                            </div>
                            <span class="status-badge ${currentClassStatus[c.class_name] ? 'online' : 'offline'}">
                                ${currentClassStatus[c.class_name] ? '在线' : '离线'}
                            </span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // 生成教师列表HTML
        function generateTeacherList(teachers) {
            if (!teachers || teachers.length === 0) {
                return '<p class="text-muted">暂无教师</p>';
            }
            
            return `
                <ul class="details-list">
                    ${teachers.map(t => `
                        <li class="details-item">
                            <div>
                                <strong>${t.token}</strong>
                                ${t.description ? `<br><small class="text-muted">${t.description}</small>` : ''}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // 生成绑定关系列表HTML
        function generateBindingList(bindings) {
            if (!bindings || bindings.length === 0) {
                return '<p class="text-muted">暂无绑定关系</p>';
            }
            
            return `
                <ul class="details-list">
                    ${bindings.map(b => `
                        <li class="details-item">
                            <div>
                                <strong>教师:</strong> ${b.teacher_token}<br>
                                <strong>班级:</strong> ${b.class_name}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // 生成在线班级列表HTML
        function generateOnlineClassList() {
            const onlineClasses = Object.entries(currentClassStatus)
                .filter(([_, status]) => status)
                .map(([className]) => className);
            
            if (onlineClasses.length === 0) {
                return '<p class="text-muted">当前没有在线班级</p>';
            }
            
            return `
                <ul class="details-list">
                    ${onlineClasses.map(className => `
                        <li class="details-item online">
                            <div>
                                <strong>${className}</strong>
                            </div>
                            <span class="status-badge online">在线</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // 生成消息列表HTML
        function generateMessageList(messages) {
            if (!messages || messages.length === 0) {
                return '<p class="text-muted">暂无广播消息记录</p>';
            }
            
            return `
                <ul class="details-list">
                    ${messages.map(message => `
                        <li class="details-item">
                            <div class="message-header">
                                <div class="message-meta">
                                    <span class="message-type-badge message-type-${message.type}">
                                        ${message.type === 'text' ? '文本' : '语音'}
                                    </span>
                                    <span class="ms-2">发送者: ${message.sender_role === 'admin' ? '管理员' : message.sender_token}</span>
                                    <span class="ms-2">目标班级: ${message.target_class}</span>
                                </div>
                                <div class="text-muted">
                                    ${new Date(message.created_at).toLocaleString()}
                                </div>
                            </div>
                            <div class="message-content">
                                ${message.type === 'text' ? 
                                    `<div class="message-text">${message.content}</div>` :
                                    `<div class="audio-player">
                                        <audio controls src="${message.content}">
                                            您的浏览器不支持音频播放
                                        </audio>
                                    </div>`
                                }
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查认证
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // 初始化WebSocket连接
                connectWebSocket();
                
                // 等待仪表盘数据加载
                await updateDashboard();
                
                // 初始化其他功能
                await Promise.all([
                    loadTeacherTokens(),
                    loadClassTokens(),
                    loadBindings(),
                    loadMessages()
                ]);
                
                // 初始化导航
                initializeNavigation();
                
                // 显示仪表盘
                showContent('dashboard');
            } catch (error) {
                console.error('初始化失败:', error);
                alert('系统初始化失败，请刷新页面重试');
            }
        });

        // 初始化导航
        function initializeNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (!item.dataset.content) return;  // 跳过没有content属性的项（如退出登录）
                    
                    // 更新导航项状态
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // 显示对应内容
                    showContent(item.dataset.content);
                });
            });
        }

        // 显示内容区域
        function showContent(contentId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const contentElement = document.getElementById(contentId + 'Content');
            if (contentElement) {
                contentElement.classList.add('active');
                
                // 根据不同的内容区域执行相应的初始化
                switch(contentId) {
                    case 'broadcast':
                        loadClassList();  // 加载班级列表
                        updateOnlineClassList(currentClassStatus);  // 更新在线班级状态
                        break;
                    case 'messages':
                        loadMessages();  // 重新加载消息记录
                        break;
                    case 'dashboard':
                        updateDashboard();  // 更新仪表盘数据
                        break;
                }
            }
        }

        // 更新仪表盘数据
        async function updateDashboard() {
            try {
                const responses = await Promise.all([
                    fetch('/api/admin/teacher-tokens', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/class-tokens', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/teacher-class-bindings', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/broadcast-messages', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                // 检查所有响应
                for (const response of responses) {
                    if (!response.ok) {
                        throw new Error('获取数据失败: ' + response.statusText);
                    }
                }

                // 解析所有响应
                const [teachers, classes, bindings, messages] = await Promise.all(
                    responses.map(r => r.json())
                );

                // 更新显示
                document.getElementById('teacherCount').textContent = 
                    Array.isArray(teachers) ? teachers.length : '0';
                document.getElementById('classCount').textContent = 
                    Array.isArray(classes) ? classes.length : '0';
                document.getElementById('bindingCount').textContent = 
                    Array.isArray(bindings) ? bindings.length : '0';
                document.getElementById('messageCount').textContent = 
                    Array.isArray(messages) ? messages.length : '0';
                
                // 更新在线班级数
                if (currentClassStatus) {
                    const onlineCount = Object.values(currentClassStatus).filter(status => status).length;
                    document.getElementById('onlineCount').textContent = onlineCount;
                }

                return true;
            } catch (error) {
                console.error('更新仪表盘失败:', error);
                // 显示错误信息
                const dashboardContent = document.getElementById('dashboardContent');
                if (dashboardContent) {
                    dashboardContent.insertAdjacentHTML('afterbegin', 
                        `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                            更新仪表盘数据失败: ${error.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`
                    );
                }
                return false;
            }
        }

        // 检查登录状态
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            console.log('当前token:', token ? '已设置' : '未设置');  // 添加日志
            if (!token) {
                console.log('未登录，跳转到登录页面');  // 添加日志
                window.location.href = '/admin/login.html';
            }
            return token;
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login.html';
        }

        // API请求函数
        async function apiRequest(url, method = 'GET', body = null) {
            const token = checkAuth();
            console.log('发起API请求:', url, method);  // 添加日志
            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: body ? JSON.stringify(body) : null
                });

                console.log('API响应状态:', response.status);  // 添加日志

                if (response.status === 401 || response.status === 403) {
                    console.log('认证失败，需要重新登录');  // 添加日志
                    logout();
                    return null;
                }

                const data = await response.json();
                console.log('API返回数据:', url, data);  // 添加日志

                if (!response.ok) {
                    throw new Error(data.error || '请求失败');
                }

                return data;
            } catch (error) {
                console.error('API请求失败:', url, error);
                throw error;
            }
        }

        // 加载教师口令列表
        async function loadTeacherTokens() {
            const tokens = await apiRequest('/api/admin/teacher-tokens');
            if (!tokens) return;

            const container = document.getElementById('teacherTokenList');
            container.innerHTML = tokens.map(token => `
                <div class="token-item">
                    <div class="token-info">
                        <strong>口令:</strong> ${token.token}<br>
                        <small>描述: ${token.description || '无'}</small>
                    </div>
                    <div class="token-actions">
                        <button class="btn btn-info btn-sm" onclick="editToken('teacher', ${token.id}, '${token.token}', null, '${token.description || ''}')">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTeacherToken(${token.id})">删除</button>
                    </div>
                </div>
            `).join('');

            // 更新教师选择下拉框
            const teacherSelect = document.getElementById('teacherSelect');
            teacherSelect.innerHTML = '<option value="">选择教师</option>' + 
                tokens.map(t => `<option value="${t.id}">${t.token} (${t.description || '无描述'})</option>`).join('');
        }

        // 加载班级口令列表
        async function loadClassTokens() {
            const tokens = await apiRequest('/api/admin/class-tokens');
            if (!tokens) return;

            const container = document.getElementById('classTokenList');
            container.innerHTML = tokens.map(token => `
                <div class="token-item">
                    <div class="token-info">
                        <strong>班级:</strong> ${token.class_name}<br>
                        <strong>口令:</strong> ${token.token}<br>
                        <small>描述: ${token.description || '无'}</small>
                    </div>
                    <div class="token-actions">
                        <button class="btn btn-info btn-sm" onclick="editToken('class', ${token.id}, '${token.token}', '${token.class_name}', '${token.description || ''}')">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClassToken(${token.id})">删除</button>
                    </div>
                </div>
            `).join('');

            // 更新班级选择下拉框
            const classSelect = document.getElementById('classSelect');
            classSelect.innerHTML = '<option value="">选择班级</option>' + 
                tokens.map(t => `<option value="${t.id}">${t.class_name} (${t.token})</option>`).join('');
        }

        // 加载绑定关系
        async function loadBindings() {
            const bindings = await apiRequest('/api/admin/teacher-class-bindings');
            if (!bindings) return;

            const container = document.getElementById('bindingList');
            container.innerHTML = bindings.map(binding => `
                <div class="binding-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>教师:</strong> ${binding.teacher_token} (${binding.teacher_description || '无描述'})<br>
                            <strong>班级:</strong> ${binding.class_name} (${binding.class_token})
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteBinding(${binding.id})">解除绑定</button>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html> 